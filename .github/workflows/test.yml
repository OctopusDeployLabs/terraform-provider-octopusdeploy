name: Run integration tests against Octopus in a Docker container

on: push

defaults:
  run:
    shell: bash

jobs:
  test:
    env:
      OCTOPUS_VERSION: "2020.2.7"
      OCTOPUS_URL: "http://localhost:8080"

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1

      - name: Build
        run: go build -v .

      - name: Start the Octopus container
        run: ./tests/start-octopus.sh

      - name: Generate an API key
        run: ./tests/Create-ApiKey.ps1
        shell: pwsh

      - name: Test
        run: go test -v ./octopusdeploy/...
